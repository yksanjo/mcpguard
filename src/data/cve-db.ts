import type { CVEEntry, Severity } from '../types/index.js';

export const CVE_DATABASE: CVEEntry[] = [
  {
    id: 'CVE-2025-49596',
    title: 'MCP Prompt Injection via Tool Description',
    description:
      'MCP servers may be vulnerable to prompt injection attacks through maliciously crafted tool descriptions that can override system prompts and manipulate LLM behavior.',
    severity: 'critical',
    affected_packages: ['*'],
    detection_patterns: [
      'ignore\\s+(previous|all|above)\\s+(instructions?|prompts?)',
      '<\\|im_(start|end)\\|>',
      '\\[INST\\].*\\[/INST\\]',
      'system:\\s*override',
      '###\\s*(system|user|assistant)',
    ],
    published_date: '2025-01-15',
    references: [
      'https://nvd.nist.gov/vuln/detail/CVE-2025-49596',
      'https://adversa.ai/blog/mcp-security-vulnerabilities',
    ],
  },
  {
    id: 'CVE-2025-49597',
    title: 'MCP Tool Poisoning via Malicious Server Registry',
    description:
      'Attackers can publish malicious MCP servers to public registries that execute arbitrary code when connected.',
    severity: 'critical',
    affected_packages: ['mcp-server-*', '@mcp/*'],
    detection_patterns: [
      'eval\\s*\\(',
      'Function\\s*\\(',
      'child_process',
      'require\\s*\\(\\s*["\']child',
    ],
    published_date: '2025-01-18',
    references: [
      'https://nvd.nist.gov/vuln/detail/CVE-2025-49597',
      'https://unit42.paloaltonetworks.com/mcp-attack-vectors',
    ],
  },
  {
    id: 'CVE-2025-49598',
    title: 'MCP Rug Pull Attack via Dynamic Tool Modification',
    description:
      'MCP servers can dynamically modify their tool definitions after initial trust verification, allowing malicious capabilities to be added post-approval.',
    severity: 'high',
    affected_packages: ['*'],
    detection_patterns: [
      'dynamic',
      'runtime',
      'loadTool',
      'registerTool',
    ],
    published_date: '2025-01-20',
    references: [
      'https://nvd.nist.gov/vuln/detail/CVE-2025-49598',
    ],
  },
  {
    id: 'CVE-2025-49599',
    title: 'MCP Cross-Server Data Exfiltration',
    description:
      'Malicious MCP servers can access data from other connected MCP servers in multi-agent environments, leading to data exfiltration.',
    severity: 'high',
    affected_packages: ['*'],
    detection_patterns: [
      'getServers',
      'listTools',
      'callTool.*other',
      'crossServer',
    ],
    published_date: '2025-01-22',
    references: [
      'https://nvd.nist.gov/vuln/detail/CVE-2025-49599',
    ],
  },
  {
    id: 'CVE-2025-49600',
    title: 'MCP Token Exhaustion Attack',
    description:
      'MCP servers can generate excessive tool output that exhausts API tokens, causing denial of service and unexpected costs.',
    severity: 'medium',
    affected_packages: ['*'],
    detection_patterns: [
      'stream',
      'unlimited',
      'no.*limit',
      'max.*tokens.*-1',
    ],
    published_date: '2025-01-23',
    references: [
      'https://nvd.nist.gov/vuln/detail/CVE-2025-49600',
    ],
  },
];

export function findCVEByPattern(content: string): CVEEntry[] {
  const matches: CVEEntry[] = [];

  for (const cve of CVE_DATABASE) {
    for (const pattern of cve.detection_patterns) {
      try {
        const regex = new RegExp(pattern, 'i');
        if (regex.test(content)) {
          matches.push(cve);
          break; // Only add CVE once even if multiple patterns match
        }
      } catch {
        // Skip invalid patterns
      }
    }
  }

  return matches;
}

export function findCVEById(id: string): CVEEntry | undefined {
  return CVE_DATABASE.find(cve => cve.id === id);
}

export function findCVEsByPackage(packageName: string): CVEEntry[] {
  return CVE_DATABASE.filter(cve => {
    for (const affected of cve.affected_packages) {
      if (affected === '*') return true;
      if (affected === packageName) return true;
      // Handle wildcard patterns like 'mcp-server-*'
      if (affected.endsWith('*')) {
        const prefix = affected.slice(0, -1);
        if (packageName.startsWith(prefix)) return true;
      }
    }
    return false;
  });
}

export function getCVEsBySeverity(severity: Severity): CVEEntry[] {
  return CVE_DATABASE.filter(cve => cve.severity === severity);
}

export function getAllCVEs(): CVEEntry[] {
  return [...CVE_DATABASE];
}
